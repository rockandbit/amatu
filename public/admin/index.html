<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin</title>
    <script>
      // Activar inicialización manual de Decap CMS
      window.CMS_MANUAL_INIT = true;
    </script>
    <!-- React + ReactDOM (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
  </head>
  <body>
    <noscript>Este panel requiere JavaScript.</noscript>

    <script>
      // Backend bridge mínimo
      class BridgeBackend {
        constructor(config) {
          this.apiBase = "/api/cms";
        }

        // Pantalla de login
        authComponent() {
          const React = window.React;
          class LoginView extends React.Component {
            componentDidMount() {
              window.location.href = "/api/auth/start";
            }
            render() {
              return React.createElement(
                "div",
                null,
                "Redirigiendo al inicio de sesión…"
              );
            }
          }
          return { component: LoginView, props: {} };
        }

        authenticate() {
          window.location.href = "/api/auth/start";
          return Promise.resolve();
        }

        logout() {
          window.location.href = "/api/auth/logout";
          return Promise.resolve();
        }

        async auth() {
          const r = await fetch(this.apiBase + "/me", {
            credentials: "include",
          });
          if (!r.ok) throw new Error("Not authenticated");
          return { token: "session" };
        }

        async restoreUser() {
          return this.auth();
        }

        async entriesByFolder({ folder }) {
          const r = await fetch(
            `${this.apiBase}/entriesByFolder?folder=${encodeURIComponent(
              folder
            )}`,
            { credentials: "include" }
          );
          return r.json();
        }

        async entriesByFiles({ files }) {
          const r = await fetch(this.apiBase + "/entriesByFiles", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ files }),
          });
          return r.json();
        }

        async getEntry({ path }) {
          const r = await fetch(
            `${this.apiBase}/entry?path=${encodeURIComponent(path)}`,
            { credentials: "include" }
          );
          return r.json();
        }

        async persistEntry({ entry, assets }) {
          const r = await fetch(this.apiBase + "/persistEntry", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ entry, assets }),
          });
          if (!r.ok) throw new Error("Persist failed");
          return r.json();
        }

        async getMedia() {
          const r = await fetch(this.apiBase + "/media", {
            credentials: "include",
          });
          return r.json();
        }

        async persistMedia({ fileObj }) {
          const b = new FormData();
          b.append("file", fileObj);
          const r = await fetch(this.apiBase + "/media", {
            method: "POST",
            credentials: "include",
            body: b,
          });
          return r.json();
        }

        async deleteFile({ path }) {
          const r = await fetch(this.apiBase + "/deleteFile", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path }),
          });
          return r.json();
        }
      }

      // Registrar backend
      window.CMS.registerBackend("bridge", BridgeBackend);

      // Inicialización: verificar sesión antes
      (async function boot() {
        try {
          const ok = await fetch("/api/cms/me", { credentials: "include" });
          if (!ok.ok) {
            window.location.href = "/api/auth/start";
            return;
          }
          window.CMS.init();
        } catch (e) {
          window.location.href = "/api/auth/start";
        }
      })();
    </script>
  </body>
</html>
