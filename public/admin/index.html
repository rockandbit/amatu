<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin</title>
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
  </head>
  <body>
    <noscript>Este panel requiere JavaScript.</noscript>
    <script>
      // Backend bridge mínimo
      class BridgeBackend {
        constructor(config) {
          this.apiBase = "/api/cms";
        }
        authComponent() {
          // Devuelve un componente React para la pantalla de login
          const React = window.React;
          class LoginView extends React.Component {
            componentDidMount() {
              // Redirige a tu formulario de login del bridge
              window.location.href = "/api/auth/start";
            }
            render() {
              return React.createElement(
                "div",
                null,
                "Redirigiendo al inicio de sesión…"
              );
            }
          }
          return { component: LoginView, props: {} };
        }
        authenticate() {
          // Si Decap llama a authenticate(), también redirigimos
          window.location.href = "/api/auth/start";
          return Promise.resolve();
        }
        logout() {
          // Cerrar sesión del bridge
          window.location.href = "/api/auth/logout";
          return Promise.resolve();
        }
        async auth() {
          const r = await fetch(this.apiBase + "/me", {
            credentials: "include",
          });
          if (!r.ok) throw new Error("Not authenticated");
          return { token: "session" };
        }
        async restoreUser() {
          return this.auth();
        }
        async entriesByFolder({ folder }) {
          const r = await fetch(
            `${this.apiBase}/entriesByFolder?folder=${encodeURIComponent(
              folder
            )}`,
            { credentials: "include" }
          );
          return r.json();
        }
        async entriesByFiles({ files }) {
          const r = await fetch(this.apiBase + "/entriesByFiles", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ files }),
          });
          return r.json();
        }
        async getEntry({ path }) {
          const r = await fetch(
            `${this.apiBase}/entry?path=${encodeURIComponent(path)}`,
            { credentials: "include" }
          );
          return r.json();
        }
        async persistEntry({ entry, assets }) {
          const r = await fetch(this.apiBase + "/persistEntry", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ entry, assets }),
          });
          if (!r.ok) throw new Error("Persist failed");
          return r.json();
        }
        async getMedia() {
          const r = await fetch(this.apiBase + "/media", {
            credentials: "include",
          });
          return r.json();
        }
        async persistMedia({ fileObj }) {
          const b = new FormData();
          b.append("file", fileObj);
          const r = await fetch(this.apiBase + "/media", {
            method: "POST",
            credentials: "include",
            body: b,
          });
          return r.json();
        }
        async deleteFile({ path }) {
          const r = await fetch(this.apiBase + "/deleteFile", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path }),
          });
          return r.json();
        }
      }

      window.CMS.registerBackend("bridge", BridgeBackend);
      window.CMS.init();
    </script>
  </body>
</html>
