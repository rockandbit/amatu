<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin</title>
  </head>
  <body>
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
    <script>
      // Backend bridge mínimo
      class BridgeBackend {
        constructor(config) {
          this.apiBase = "/api/cms";
        }
        async auth() {
          const r = await fetch(this.apiBase + "/me", {
            credentials: "include",
          });
          if (!r.ok) throw new Error("Not authenticated");
          return { token: "session" };
        }
        async restoreUser() {
          return this.auth();
        }
        async entriesByFolder({ folder }) {
          const r = await fetch(
            `${this.apiBase}/entriesByFolder?folder=${encodeURIComponent(
              folder
            )}`,
            { credentials: "include" }
          );
          return r.json();
        }
        async entriesByFiles({ files }) {
          const r = await fetch(this.apiBase + "/entriesByFiles", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ files }),
          });
          return r.json();
        }
        async getEntry({ path }) {
          const r = await fetch(
            `${this.apiBase}/entry?path=${encodeURIComponent(path)}`,
            { credentials: "include" }
          );
          return r.json();
        }
        async persistEntry({ entry, assets }) {
          const r = await fetch(this.apiBase + "/persistEntry", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ entry, assets }),
          });
          if (!r.ok) throw new Error("Persist failed");
          return r.json();
        }
        async getMedia() {
          const r = await fetch(this.apiBase + "/media", {
            credentials: "include",
          });
          return r.json();
        }
        async persistMedia({ fileObj }) {
          const b = new FormData();
          b.append("file", fileObj);
          const r = await fetch(this.apiBase + "/media", {
            method: "POST",
            credentials: "include",
            body: b,
          });
          return r.json();
        }
        async deleteFile({ path }) {
          const r = await fetch(this.apiBase + "/deleteFile", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path }),
          });
          return r.json();
        }
      }
      // Botón de login (simple): /api/auth/start
      window.CMS.registerAdditionalLink({
        id: "login",
        title: "Iniciar sesión",
        data: { href: "/api/auth/start" },
        options: { target: "_self" },
      });

      window.CMS.registerBackend("bridge", BridgeBackend);
      window.CMS.init();
    </script>
  </body>
</html>
